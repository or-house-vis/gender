---
output: github_document
---

```{r setup}
library(here)
library(tidyverse)
library(glue)
# devtools::install_github("or-house-vis/history")
library(history) 
```

# Gender by party


# Gender overall

Compute proportions of each gender:
```{r}
gender_overall <- house_reps_regular %>% 
  group_by(session_year, gender) %>% 
  count() %>%
  ungroup() %>% 
  complete(session_year, gender, fill = list(n = 0)) %>% 
  group_by(session_year) %>% 
  mutate(prop = n/sum(n),
    gender = gender %>% factor(levels = c("Male", "Female"))
    ) %>% 
  ungroup() 
```

Add captions
```{r}
overall_captions <- gender_overall %>% 
  filter(gender == "Female") %>% 
  select(session_year, n, prop) %>% 
  mutate(caption = 
      glue('<strong>{ session_year }</strong><br />{ round(prop, 2) * 100 }% ({ n } seats) held by females')
    ) %>% 
  select(session_year, caption)
```

Add captions and make sure `session_year` is a date
```{r}
gender_overall <- gender_overall %>%  
  left_join(overall_captions) %>% 
  mutate(
    session_year = ISOdate(year = session_year, 
      month = 1, day = 1, tz = "utc")
  )
```

Add some rows for annotation
```{r}
anno <- tribble(
  ~ gender, ~ session_year, ~ prop,
  "Male"  ,           1865,    0.95,
  "Female",           2013,    0.05
) %>% 
  mutate(
    session_year = ISOdate(year = session_year, 
      month = 1, day = 1, tz = "utc")
  )
anno$data = "annotation"
```

```{r}
gender_overall_captioned <- 
  gender_overall %>% 
  mutate(data = "data") %>% 
  bind_rows(anno)
```
Examine changes
```{r, eval = FALSE}
library(daff)
old <- read_csv(here("docs", "data", "vega-gender-overall.csv"))
diffs <- diff_data(gender_overall_captioned, old, ordered = FALSE)
render_diff(diffs)
```

```{r}
gender_overall_captioned %>% 
  write_csv(here("docs", "data", "vega-gender-overall.csv"))
```

